#!/bin/bash

umask 077

LOG="/tmp/minecraft-maps-setup"
INSTALL="/usr/local/games/minecraft"

log() {
    local msg="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') $msg" >> $LOG
}

log "setting up maps"

if [ ! -d $INSTALL/overviewer ]; then
    cd $INSTALL

    log "cloning overviewer repository"
    if ! git clone https://github.com/overviewer/Minecraft-Overviewer.git overviewer &>>$LOG ; then
        exit -1
    fi

    cd overviewer

    log "building overviewer"
    if ! python setup.py build &>>$LOG ; then
        exit -1
    fi

    chown -v -R mcraft:mcraft $INSTALL/overviewer &>>$LOG
fi

if [ ! -d $INSTALL/maps ]; then
    log "creating directories"
    mkdir -v -p $INSTALL/maps $INSTALL/maps/build $INSTALL/maps/www &>>$LOG
    chown -v -R mcraft:mcraft $INSTALL/maps &>>$LOG
fi

log "setting permissions"
chmod -v 711 $INSTALL $INSTALL/maps $INSTALL/maps/www &>>$LOG

